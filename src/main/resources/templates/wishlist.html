<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GAME VAULT - ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #0f1629 100%);
      min-height: 100vh;
    }

    body.light-mode {
      background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 50%, #e6eef5 100%);
    }

    .neon-border {
      border: 1px solid rgba(0, 212, 255, 0.3);
      box-shadow: 0 0 20px rgba(0, 212, 255, 0.1);
    }

    .light-mode .neon-border {
      border: 1px solid rgba(0, 150, 255, 0.2);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>

<body th:classappend="${!darkMode} ? 'light-mode' : ''"
  th:class="${darkMode} ? 'bg-gray-900 text-gray-100' : 'bg-gray-50 text-gray-800'">
  <div class="max-w-7xl mx-auto p-4">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ† -->
    <div th:classappend="${darkMode} ? 'bg-gray-800/50' : 'bg-white/80'"
      class="backdrop-blur-md rounded-2xl p-6 mb-6 neon-border">
      <div class="flex justify-between items-center">
        <div>
          <h1
            class="text-3xl font-bold bg-gradient-to-r from-cyan-400 via-purple-500 to-pink-500 bg-clip-text text-transparent">
            ğŸ“‹ GAME VAULT
          </h1>
          <p th:classappend="${darkMode} ? 'text-gray-400' : 'text-gray-600'" class="text-sm mt-1">ãƒã‚¤ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆ</p>
        </div>

        <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <div class="flex items-center space-x-3">
          <a href="/deals"
            th:classappend="${darkMode} ? 'bg-blue-700 hover:bg-blue-600' : 'bg-blue-600 hover:bg-blue-700'"
            class="text-white px-4 py-2 rounded-lg transition-all shadow-lg">
            ğŸ® ã‚»ãƒ¼ãƒ«ä¸€è¦§ã¸
          </a>
          <a href="/settings"
            th:classappend="${darkMode} ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'"
            class="px-4 py-2 rounded-lg transition-all">
            âš™ï¸ è¨­å®š
          </a>
          <div th:classappend="${darkMode} ? 'text-gray-300' : 'text-gray-700'" class="text-sm text-right">
            <span th:text="'ã‚ˆã†ã“ãã€' + ${username} + ' ã•ã‚“ï¼'"></span><br>
            <span th:classappend="${darkMode} ? 'text-gray-500' : 'text-gray-500'" class="text-xs"
              th:text="'ID: ' + ${userid}"></span>
          </div>
          <a href="/logout"
            th:classappend="${darkMode} ? 'text-cyan-400 hover:text-cyan-300' : 'text-blue-600 hover:text-blue-800'"
            class="hover:underline text-sm">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
        </div>
      </div>
    </div>

    <!-- ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆãŒç©ºã®å ´åˆ -->
    <div th:if="${#lists.isEmpty(wishlistItems)}" th:classappend="${darkMode} ? 'bg-gray-800/50' : 'bg-white/80'"
      class="backdrop-blur-md rounded-2xl p-12 text-center neon-border">
      <div class="text-6xl mb-4">ğŸ“­</div>
      <p th:classappend="${darkMode} ? 'text-gray-400' : 'text-gray-600'" class="text-xl mb-6">ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆã«ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</p>
      <a href="/deals"
        th:classappend="${darkMode} ? 'bg-gradient-to-r from-cyan-500 to-blue-600' : 'bg-gradient-to-r from-blue-500 to-blue-600'"
        class="text-white px-8 py-4 rounded-lg inline-block transition-all shadow-lg hover:shadow-xl font-semibold">
        ğŸ® ã‚»ãƒ¼ãƒ«æƒ…å ±ã‚’è¦‹ã‚‹
      </a>
    </div>

    <!-- ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆè¡¨ç¤º -->
    <div th:if="${!#lists.isEmpty(wishlistItems)}"
      class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">

      <div th:each="item : ${wishlistItems}" th:data-game-id="${item.gameId}" th:data-shop="${item.shop}"
        th:data-title="${item.gameTitle}"
        th:classappend="${darkMode} ? 'bg-gray-800/80 border border-cyan-500/20' : 'bg-white hover:shadow-2xl border border-blue-200'"
        class="wishlist-card flex flex-col h-full rounded-2xl shadow-lg transition-all relative overflow-hidden group backdrop-blur-sm">

        <!-- å‰Šé™¤ãƒœã‚¿ãƒ³ -->
        <button th:data-game-id="${item.gameId}" th:data-shop="${item.shop}"
          class="delete-btn absolute top-3 right-3 bg-red-500 text-white w-10 h-10 rounded-full hover:bg-red-600 transition-all z-10 shadow-xl font-bold text-xl">
          Ã—
        </button>

        <!-- ã‚²ãƒ¼ãƒ ç”»åƒ -->
        <div class="relative overflow-hidden">
          <img th:src="${item.gameImage != null ? item.gameImage : 'https://placehold.co/400x185?text=No+Image'}"
            class="w-full rounded-t-2xl transition-transform group-hover:scale-105" alt="thumbnail">
        </div>

        <!-- ã‚²ãƒ¼ãƒ æƒ…å ± -->
        <div class="p-5 flex flex-col flex-grow">
          <h2 class="font-bold text-lg mb-2 line-clamp-2" th:text="${item.gameTitle}"></h2>
          <p th:classappend="${darkMode} ? 'text-gray-400' : 'text-gray-600'" class="text-sm mb-2"
            th:text="'ğŸª ' + ${item.shop}"></p>

          <!-- é€šå¸¸ä¾¡æ ¼ï¼ˆã‚»ãƒ¼ãƒ«ãŒã‚ã‚‹å ´åˆã®ã¿è¡¨ç¤ºï¼‰ -->
          <p th:if="${item.priceOld != null and item.cut != null and item.cut > 0}"
            th:classappend="${darkMode} ? 'text-gray-400' : 'text-gray-600'" class="text-sm mb-1">
            é€šå¸¸: <span class="line-through" th:text="${T(java.lang.Math).floor(item.priceOld)} + 'å††'"></span>
          </p>

          <!-- ä¾¡æ ¼ -->
          <p class="text-red-500 font-bold text-xl mb-2" th:text="${T(java.lang.Math).floor(item.currentPrice)} + 'å††'">
          </p>

          <!-- å‰²å¼•ç‡ï¼ˆã‚»ãƒ¼ãƒ«ãŒã‚ã‚‹å ´åˆã®ã¿è¡¨ç¤ºï¼‰ -->
          <p th:if="${item.cut != null and item.cut > 0}" class="text-sm text-green-500 font-semibold mb-2"
            th:text="'ğŸ’° ' + ${item.cut} + '% OFF'"></p>

          <!-- ã‚»ãƒ¼ãƒ«çµ‚äº†æ—¥æ™‚ -->
          <div th:if="${item.expiry != null}" class="mb-2">
            <p class="text-sm" th:attr="data-expiry=${item.expiry}" id="expiry-text"></p>
            <script th:inline="javascript">
              (function () {
                const expiryStr = /*[[${item.expiry}]]*/ null;
                if (expiryStr) {
                  try {
                    const expiryDate = new Date(expiryStr);
                    const now = new Date();
                    const diffTime = expiryDate - now;
                    const diffHours = Math.floor(diffTime / (1000 * 60 * 60));
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    const element = document.currentScript.previousElementSibling;

                    const expiryDateStr = expiryDate.toLocaleDateString('ja-JP', {
                      year: 'numeric',
                      month: 'long',
                      day: 'numeric',
                      hour: '2-digit',
                      minute: '2-digit'
                    });

                    if (diffHours < 0) {
                      element.className = 'text-sm text-red-500 font-semibold';
                      element.textContent = 'â° ã‚»ãƒ¼ãƒ«çµ‚äº†æ¸ˆã¿ (' + expiryDateStr + ')';
                    } else if (diffHours < 24) {
                      element.className = 'text-sm text-red-500 font-semibold animate-pulse';
                      element.textContent = 'â° æ®‹ã‚Š ' + diffHours + 'æ™‚é–“ (' + expiryDateStr + ')';
                    } else if (diffDays <= 3) {
                      element.className = 'text-sm text-orange-500 font-semibold';
                      element.textContent = 'â° æ®‹ã‚Š ' + diffDays + 'æ—¥ (' + expiryDateStr + ')';
                    } else if (diffDays <= 7) {
                      element.className = 'text-sm text-yellow-500 font-semibold';
                      element.textContent = 'â° æ®‹ã‚Š ' + diffDays + 'æ—¥ (' + expiryDateStr + ')';
                    } else {
                      element.className = 'text-sm [[${darkMode}]] ? text-gray-400 : text-gray-600';
                      element.textContent = 'â° ' + expiryDateStr + 'ã¾ã§';
                    }
                  } catch (e) {
                    console.error('Error parsing expiry:', e);
                  }
                }
              })();
            </script>
          </div>

          <!-- éå»æœ€å®‰å€¤ -->
          <p th:if="${item.historyLow != null}" th:classappend="${darkMode} ? 'text-gray-400' : 'text-gray-600'"
            class="text-xs mb-3" th:text="'ğŸ•’ éå»æœ€å®‰å€¤: ' + ${T(java.lang.Math).floor(item.historyLow)} + 'å††'"></p>

          <div class="mt-auto">
            <!-- æœ€æ–°æƒ…å ±ãƒœã‚¿ãƒ³ -->
            <button th:data-game-id="${item.gameId}" th:data-shop="${item.shop}" th:data-title="${item.gameTitle}"
              class="view-latest-btn block w-full text-center text-white px-4 py-2 rounded-lg bg-gradient-to-r from-cyan-500 to-cyan-600 hover:from-cyan-400 hover:to-cyan-500 hover:shadow-lg transition-all mb-3 font-semibold text-sm">
              â„¹ï¸ æœ€æ–°æƒ…å ±ã‚’ã¿ã‚‹
            </button>

            <!-- ã‚¹ãƒˆã‚¢ãƒªãƒ³ã‚¯ãƒœã‚¿ãƒ³ -->
            <a th:if="${item.url != null and item.url != ''}" th:href="${item.url}" target="_blank"
              th:classappend="${darkMode} ? 'bg-gradient-to-r from-blue-600 to-blue-700' : 'bg-gradient-to-r from-blue-500 to-blue-600'"
              class="block w-full text-center text-white px-4 py-3 rounded-lg hover:shadow-xl transition-all mb-3 font-semibold">
              ğŸ›’ ã‚¹ãƒˆã‚¢ã§è¦‹ã‚‹
            </a>

            <!-- URLãŒãªã„å ´åˆã®è¡¨ç¤º -->
            <div th:if="${item.url == null or item.url == ''}"
              th:classappend="${darkMode} ? 'bg-gray-700 text-gray-500' : 'bg-gray-200 text-gray-500'"
              class="block w-full text-center px-4 py-3 rounded-lg mb-3 cursor-not-allowed">
              ãƒªãƒ³ã‚¯ãªã—
            </div>
          </div>

          <p th:classappend="${darkMode} ? 'text-gray-500' : 'text-gray-400'" class="text-xs text-center"
            th:text="'è¿½åŠ : ' + ${#temporals.format(item.addedAt, 'yyyy/MM/dd HH:mm')}"></p>
        </div>
      </div>
    </div>

    <!-- ã‚¢ã‚¤ãƒ†ãƒ æ•°è¡¨ç¤º -->
    <div th:if="${!#lists.isEmpty(wishlistItems)}" th:classappend="${darkMode} ? 'bg-gray-800/50' : 'bg-white/80'"
      class="backdrop-blur-md rounded-2xl p-4 mt-6 text-center neon-border">
      <p th:classappend="${darkMode} ? 'text-gray-400' : 'text-gray-600'" class="font-semibold"
        th:text="'å…¨ ' + ${#lists.size(wishlistItems)} + ' ä»¶ã®ã‚¢ã‚¤ãƒ†ãƒ '"></p>
    </div>
  </div>

  <!-- ã‚²ãƒ¼ãƒ è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="gameModal"
    class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden items-center justify-center z-50 overflow-y-auto py-8">
    <div th:classappend="${darkMode} ? 'bg-gray-800 text-gray-100' : 'bg-white text-gray-800'"
      class="rounded-3xl shadow-2xl w-11/12 max-w-4xl p-8 relative neon-border my-auto">
      <button id="closeModal"
        th:classappend="${darkMode} ? 'text-gray-400 hover:text-gray-100' : 'text-gray-500 hover:text-black'"
        class="absolute top-4 right-4 text-3xl font-bold z-10 bg-gray-800/80 hover:bg-gray-700/80 rounded-full w-10 h-10 flex items-center justify-center">Ã—</button>
      <div id="modalContent" class="space-y-4">
        <p th:classappend="${darkMode} ? 'text-gray-400' : 'text-gray-500'" class="text-center">èª­ã¿è¾¼ã¿ä¸­...</p>
      </div>

      <!-- ã‚¹ãƒˆã‚¢ãƒªãƒ³ã‚¯ã¨ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆè¿½åŠ ãƒœã‚¿ãƒ³ -->
      <div id="storeLinkContainer" class="mt-6 flex gap-3 justify-center hidden">
        <a id="storeLink" href="#" target="_blank"
          class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-3 rounded-lg hover:shadow-xl transition-all font-semibold">
          ğŸ”— ã‚¹ãƒˆã‚¢ãƒšãƒ¼ã‚¸
        </a>
        <button id="addToWishlistBtn"
          class="bg-gradient-to-r from-yellow-500 to-yellow-600 text-white px-6 py-3 rounded-lg hover:shadow-xl transition-all font-semibold">
          â­ ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆè¿½åŠ 
        </button>
      </div>
    </div>
  </div>

  <!-- ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="confirmModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden items-center justify-center z-50">
    <div th:classappend="${darkMode} ? 'bg-gray-800 text-gray-100' : 'bg-white text-gray-800'"
      class="rounded-2xl shadow-2xl p-6 max-w-md mx-4">
      <h3 class="text-xl font-bold mb-4">ç¢ºèª</h3>
      <p id="confirmMessage" class="mb-6"></p>
      <div class="flex gap-3 justify-end">
        <button id="confirmCancel"
          th:classappend="${darkMode} ? 'bg-gray-600 hover:bg-gray-700' : 'bg-gray-300 hover:bg-gray-400'"
          class="px-6 py-2 rounded-lg transition-colors">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button id="confirmOk"
          class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg transition-colors">æ›´æ–°</button>
      </div>
    </div>
  </div>

  <!-- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ -->
  <div id="toast" class="fixed top-4 right-4 z-50 hidden">
    <div id="toastContent" class="rounded-lg shadow-lg p-4 border-l-4 min-w-[300px] transition-all duration-300">
      <div class="flex items-center">
        <span id="toastIcon" class="text-2xl mr-3"></span>
        <p id="toastMessage" class="flex-1 font-medium"></p>
        <button id="toastClose" class="ml-4 text-gray-500 hover:text-gray-700 text-xl font-bold leading-none">Ã—</button>
      </div>
    </div>
  </div>

  <script th:inline="javascript">
    const darkMode = /*[[${darkMode != null ? darkMode : true}]]*/ true;

    // ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥è¡¨ç¤ºé–¢æ•°
    function showToast(message, isSuccess = true) {
      const toast = document.getElementById("toast");
      const toastContent = document.getElementById("toastContent");
      const toastIcon = document.getElementById("toastIcon");
      const toastMessage = document.getElementById("toastMessage");
      const toastClose = document.getElementById("toastClose");

      if (!toast || !toastContent || !toastIcon || !toastMessage || !toastClose) return;

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¨­å®š
      toastMessage.textContent = message;
      toastIcon.textContent = isSuccess ? "âœ…" : "âš ï¸";

      // ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¨­å®š
      const bgClass = darkMode
        ? (isSuccess ? "bg-gray-800 text-gray-100" : "bg-gray-800 text-gray-100")
        : (isSuccess ? "bg-white text-gray-800" : "bg-white text-gray-800");
      const borderColor = isSuccess ? "border-green-500" : "border-yellow-500";

      toastContent.className = `rounded-lg shadow-lg p-4 border-l-4 min-w-[300px] transition-all duration-300 ${bgClass} ${borderColor}`;

      // è¡¨ç¤º
      toast.classList.remove("hidden");
      toast.style.opacity = "0";
      toast.style.transform = "translateX(100%)";

      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
      setTimeout(() => {
        toast.style.transition = "all 0.3s ease-out";
        toast.style.opacity = "1";
        toast.style.transform = "translateX(0)";
      }, 10);

      // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
      const closeToast = () => {
        toast.style.opacity = "0";
        toast.style.transform = "translateX(100%)";
        setTimeout(() => {
          toast.classList.add("hidden");
        }, 300);
      };

      toastClose.onclick = closeToast;

      // 3ç§’å¾Œã«è‡ªå‹•ã§é–‰ã˜ã‚‹
      setTimeout(closeToast, 3000);
    }

    // ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡
    let pendingDelete = null;

    const confirmModal = document.getElementById("confirmModal");
    const confirmMessage = document.getElementById("confirmMessage");
    const confirmCancel = document.getElementById("confirmCancel");
    const confirmOk = document.getElementById("confirmOk");

    function showConfirmModal(message, onConfirm) {
      confirmMessage.textContent = message;
      pendingDelete = onConfirm;
      confirmModal.classList.remove("hidden");
      confirmModal.classList.add("flex");
    }

    function hideConfirmModal() {
      confirmModal.classList.add("hidden");
      confirmModal.classList.remove("flex");
      pendingDelete = null;
    }

    confirmCancel.addEventListener("click", hideConfirmModal);
    confirmOk.addEventListener("click", () => {
      if (pendingDelete) {
        pendingDelete();
        hideConfirmModal();
      }
    });

    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    confirmModal.addEventListener("click", (e) => {
      if (e.target === confirmModal) {
        hideConfirmModal();
      }
    });

    // ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const gameId = e.target.dataset.gameId;
        const shop = e.target.dataset.shop;
        const gameTitle = e.target.closest('div[class*="rounded-2xl"]').querySelector('h2').textContent;

        showConfirmModal(`ã€Œ${gameTitle}ã€ã‚’ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹?`, async () => {
          try {
            const res = await fetch(`/api/wishlist?gameId=${encodeURIComponent(gameId)}&shop=${encodeURIComponent(shop)}`, {
              method: 'DELETE'
            });

            const result = await res.json();

            if (result.success) {
              const card = e.target.closest('div[class*="rounded-2xl"]');
              card.style.transition = 'all 0.3s ease';
              card.style.opacity = '0';
              card.style.transform = 'scale(0.8)';

              showToast('âœ… ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¾ã—ãŸ', true);

              setTimeout(() => {
                location.reload();
              }, 300);
            } else {
              showToast('âŒ ' + result.message, false);
            }
          } catch (err) {
            console.error(err);
            showToast('âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', false);
          }
        });
      });
    });

    // ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯ï¼ˆç„¡åŠ¹åŒ–ï¼‰
    // è¦æœ›ã«ã‚ˆã‚Šã‚«ãƒ¼ãƒ‰è‡ªä½“ã®ã‚¯ãƒªãƒƒã‚¯ã¯ç„¡åŠ¹ã«ã—ã€ãƒœã‚¿ãƒ³ã§ã®ã¿ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã•ã›ã‚‹

    // æœ€æ–°æƒ…å ±ã‚’ã¿ã‚‹ãƒœã‚¿ãƒ³
    document.querySelectorAll('.view-latest-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();

        const gameId = btn.dataset.gameId;
        const shop = btn.dataset.shop;
        const gameTitle = btn.dataset.title;
        // ã‚«ãƒ¼ãƒ‰ã‹ã‚‰ç”»åƒã‚’å–å¾—
        const card = btn.closest('.wishlist-card');
        const imgEl = card.querySelector('img');
        const image = imgEl ? imgEl.src : null;

        card.style.cursor = "wait";

        try {
          // update=true ã‚’ä»˜ä¸ã—ã¦è‡ªå‹•æ›´æ–°
          const res = await fetch(`/api/deal/lookup?id=${encodeURIComponent(gameId)}&shop=${encodeURIComponent(shop)}&update=true`);
          const deal = await res.json();

          if (deal) {
            if (!deal.title || deal.title === "Unknown") deal.title = gameTitle;
            if (!deal.image) deal.image = image;

            openModal(deal);

            // DOMä¸Šã®ä¾¡æ ¼è¡¨ç¤ºãªã©ã‚’æ›´æ–°ï¼ˆç°¡æ˜“çš„ã€ã¾ãŸã¯ãƒªãƒ­ãƒ¼ãƒ‰ã§ã‚‚è‰¯ã„ãŒUXå‘ä¸Šã®ãŸã‚ï¼‰
            // å®Ÿéš›ã«ã¯ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ãŸå¾Œã«ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‹ã€ã“ã“ã§DOMæ“ä½œã™ã‚‹ã‹
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€Œè‡ªå‹•ã§æƒ…å ±æ›´æ–°åŒ–ã€ã¨è¨€ã£ãŸã®ã§ã€ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰æ›´æ–°ï¼‹è©³ç´°è¡¨ç¤ºã§OKã€‚
            // ç”»é¢ä¸Šã®æ•°å­—ãŒå¤‰ã‚ã‚‰ãªã„ã¨ã€Œæ›´æ–°ã•ã‚ŒãŸã€æ„ŸãŒè–„ã„ã®ã§ã€ãƒˆãƒ¼ã‚¹ãƒˆå‡ºã—ã¤ã¤DOMæ›´æ–°ã‚’è©¦ã¿ã‚‹

            showToast('âœ… æœ€æ–°æƒ…å ±ã«æ›´æ–°ã—ã¾ã—ãŸ', true);

            // ç¾åœ¨ã®ã‚«ãƒ¼ãƒ‰ã®è¡¨ç¤ºã‚’æ›´æ–° (ShopãŒä¸€è‡´ã™ã‚‹å ´åˆã®ã¿)
            if (deal.priceNew !== undefined && deal.shop === shop) {
              // ä¾¡æ ¼è¦ç´ ã‚’æ¢ã—ã¦æ›´æ–°... ã¯æ§‹é€ ä¾å­˜ãŒé«˜ã„ã®ã§ã€å®‰å…¨ç­–ã¨ã—ã¦å°‘ã—é…ã‚Œã¦ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ï¼Ÿ
              // ã—ã‹ã—ã€Œè¦‹ã‚‹ã€ãƒœã‚¿ãƒ³ãªã®ã§ã€è¦‹çµ‚ã‚ã£ãŸå¾Œã«æ›´æ–°ã•ã‚Œã¦ã„ã‚Œã°è‰¯ã„ã€‚
              // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºä¸­ãªã®ã§ã€ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ãƒ¢ãƒ¼ãƒ€ãƒ«æ¶ˆãˆã¦ã—ã¾ã†ã€‚
              // ãªã®ã§ã€ãƒªãƒ­ãƒ¼ãƒ‰ã¯ã—ãªã„ã€ã¾ãŸã¯ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ãŸæ™‚ã«ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹ã€‚

            }
          } else {
            showToast("è©³ç´°æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ", false);
          }
        } catch (err) {
          console.error(err);
          showToast("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ", false);
        } finally {
          card.style.cursor = "";
        }
      });
    });

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ãŸæ™‚ã«ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ï¼ˆã‚‚ã—æ›´æ–°ãŒã‚ã£ãŸå ´åˆ... å¸¸ã«ã—ã¡ã‚ƒã†ï¼Ÿï¼‰
    // æ¯å›ãƒªãƒ­ãƒ¼ãƒ‰ã¯ç…©ã‚ã—ã„ã‹ã€‚DOMæ›´æ–°ãŒç†æƒ³ã ãŒã€ã¨ã‚Šã‚ãˆãšãƒˆãƒ¼ã‚¹ãƒˆã ã‘ã§ååˆ†ã‹ã‚‚ã€‚
    // è¦æœ›ã¯ã€Œè‡ªå‹•ã§æƒ…å ±æ›´æ–°ã€ãªã®ã§ã€DBãŒæ›´æ–°ã•ã‚Œã¦ã„ã‚Œã°OKã€‚


    // --- Helper Functions copied/adapted from deals.js ---
    function isExcludedShop(shopName) {
      if (!shopName) return false;
      return shopName.toLowerCase().includes("indiegala");
    }

    function hasSale(deal) {
      return Number(deal?.cut || 0) > 0;
    }

    // --- Modal Logic ---
    let currentDeal = null;
    const gameModal = document.getElementById("gameModal");
    const closeModalBtn = document.getElementById("closeModal");
    const modalContent = document.getElementById("modalContent");
    const storeLinkContainer = document.getElementById("storeLinkContainer");

    function hideGameModal() {
      gameModal.classList.add("hidden");
      gameModal.classList.remove("flex");
    }

    closeModalBtn.addEventListener("click", hideGameModal);
    gameModal.addEventListener("click", (e) => {
      if (e.target === gameModal) hideGameModal();
    });

    async function openModal(deal) {
      currentDeal = deal;
      const loadingColor = darkMode ? "text-gray-400" : "text-gray-500";
      modalContent.innerHTML = `<p class="text-center ${loadingColor}">è©³ç´°ã‚’å–å¾—ä¸­...</p>`;
      storeLinkContainer.classList.add("hidden");
      gameModal.classList.remove("hidden");
      gameModal.classList.add("flex");

      try {
        const res = await fetch(`/api/gameinfo?id=${deal.gameID || deal.id}`);
        const data = await res.json();
        const bgClass = darkMode ? "bg-gray-700/50 backdrop-blur-sm" : "bg-gray-50";
        const borderClass = darkMode ? "border-gray-600" : "border-gray-300";

        const modalDeal = deal; // Already processed by backend/us
        const sale = hasSale(modalDeal);

        // ã‚¹ãƒˆã‚¢ãƒšãƒ¼ã‚¸ã¨ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆè¿½åŠ ãƒœã‚¿ãƒ³(æ—¢å­˜ãƒœã‚¿ãƒ³ã‚’éš ã—ã¦æ–°è¦ä½œæˆã™ã‚‹å½¢ã§ã‚‚è‰¯ã„ãŒã€æ—¢å­˜ã®storeLinkã‚’ä½¿ã†)
        if (modalDeal?.url) {
          const storeLink = document.getElementById("storeLink");
          // ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆè¿½åŠ ãƒœã‚¿ãƒ³ã¯ã“ã®ç”»é¢ã§ã¯ä¸è¦ï¼ˆæ—¢ã«ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆãªã®ã§ï¼‰ã€ã¾ãŸã¯ã€Œæ›´æ–°ã€ã«ã™ã‚‹ï¼Ÿ
          // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æœ›ã¯ã€Œä»–ã®æƒ…å ±ã®è¡¨ç¤ºã€ãªã®ã§ã€è¿½åŠ ãƒœã‚¿ãƒ³ã¯éš ã—ã¦ãŠãã‹ã€ä»–ã‚¹ãƒˆã‚¢è¿½åŠ ç”¨ã«ã™ã‚‹
          // ã“ã“ã§ã¯ãƒ¡ã‚¤ãƒ³ã®ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ã¯è¡¨ç¤ºã•ã›ã¤ã¤ã€è¿½åŠ ãƒœã‚¿ãƒ³ã¯éè¡¨ç¤ºã«ã™ã‚‹
          storeLink.href = modalDeal.url;
          storeLinkContainer.classList.remove("hidden");
          document.getElementById("addToWishlistBtn").classList.add("hidden"); // ãƒ¡ã‚¤ãƒ³ã®è¿½åŠ ãƒœã‚¿ãƒ³ã¯éš ã™
        } else {
          storeLinkContainer.classList.add("hidden");
        }

        // æœ€å®‰å€¤ã‚¹ãƒˆã‚¢ã®æƒ…å ±
        let modalHtml = `
          <img src="${data.assets?.banner400 || deal.image}" class="rounded-2xl w-full mb-4 shadow-lg">
          <h2 class="text-2xl font-bold mb-3">${data.title || deal.title}</h2>
          
          <!-- (Buttons area handled separately above) -->
          
          <div class="${bgClass} p-4 rounded-xl mt-3 space-y-2 border ${borderClass}">
            <h3 class="text-lg font-semibold mb-2 text-green-500">ğŸ’° æœ€å®‰å€¤ã‚¹ãƒˆã‚¢</h3>
            ${modalDeal ? `
              <p class="flex items-center justify-between"><span>ã‚¹ãƒˆã‚¢</span><span class="font-bold">${modalDeal.shop}</span></p>
              <p class="flex items-center justify-between"><span>${sale ? 'ã‚»ãƒ¼ãƒ«ä¾¡æ ¼' : 'ä¾¡æ ¼'}</span><span class="font-bold text-xl text-red-500">${modalDeal.priceNew}å††</span></p>
              ${sale ? `<p class="flex items-center justify-between text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}"><span>é€šå¸¸ä¾¡æ ¼</span><span class="line-through">${modalDeal.priceOld}å††</span></p>` : ``}
              ${sale ? `<p class="flex items-center justify-between"><span class="text-green-500">å‰²å¼•ç‡</span><span class="font-bold text-green-500">${modalDeal.cut}% OFF</span></p>` : ``}
            ` : `
              <p class="text-sm opacity-70">æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>
            `}
            ${sale && modalDeal?.expiry ? (() => {
            try {
              const expiryDate = new Date(modalDeal.expiry);
              const now = new Date();
              const diffTime = expiryDate - now;
              const diffHours = Math.floor(diffTime / (1000 * 60 * 60));
              const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
              const expiryDateStr = expiryDate.toLocaleDateString('ja-JP', {
                year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
              });

              if (diffHours < 0) {
                return `<p class="text-sm mb-1 text-red-500 font-semibold"><span class="font-semibold">â° ã‚»ãƒ¼ãƒ«:</span> çµ‚äº†æ¸ˆã¿ (${expiryDateStr})</p>`;
              } else if (diffHours < 24) {
                return `<p class="text-sm mb-1 text-red-500 font-semibold animate-pulse"><span class="font-semibold">â° ã‚»ãƒ¼ãƒ«çµ‚äº†:</span> æ®‹ã‚Š ${diffHours}æ™‚é–“ (${expiryDateStr})</p>`;
              } else if (diffDays <= 3) {
                return `<p class="text-sm mb-1 text-orange-500 font-semibold"><span class="font-semibold">â° ã‚»ãƒ¼ãƒ«çµ‚äº†:</span> ${expiryDateStr} (æ®‹ã‚Š${diffDays}æ—¥)</p>`;
              } else {
                return `<p class="text-sm mb-1"><span class="font-semibold">â° ã‚»ãƒ¼ãƒ«çµ‚äº†:</span> ${expiryDateStr}</p>`;
              }
            } catch (e) { return ''; }
          })() : ''}
            ${deal.historyLow ? `<p class="flex items-center justify-between text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}"><span>ğŸ•’ éå»æœ€å®‰å€¤</span><span>${deal.historyLow}å††</span></p>` : ''}
          </div>
        `;

        // ä»–ã®ã‚¹ãƒˆã‚¢ã®æƒ…å ±ã‚’è¡¨ç¤º
        if (deal.otherDeals && deal.otherDeals.length > 0) {
          modalHtml += `
            <div class="${bgClass} p-4 rounded-xl border ${borderClass} mt-4">
              <h3 class="text-lg font-semibold mb-3">ğŸª ä»–ã®ã‚¹ãƒˆã‚¢ã®ä¾¡æ ¼</h3>
              <div class="space-y-3">
          `;

          deal.otherDeals.forEach((otherDeal, idx) => {
            if (isExcludedShop(otherDeal.shop)) return;
            const otherSale = hasSale(otherDeal);

            // Expiry logic for others
            let expiryHtml = '';
            if (otherSale && otherDeal.expiry) {
              try {
                const expiryDate = new Date(otherDeal.expiry);
                const now = new Date();
                const diffTime = expiryDate - now;
                const diffHours = Math.floor(diffTime / (1000 * 60 * 60));
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const expiryDateStr = expiryDate.toLocaleDateString('ja-JP', {
                  year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
                });

                if (diffHours < 0) {
                  expiryHtml = `<p class="text-sm mb-1 text-red-500 font-semibold">â° çµ‚äº†æ¸ˆã¿ (${expiryDateStr})</p>`;
                } else if (diffHours < 24) {
                  expiryHtml = `<p class="text-sm mb-1 text-red-500 font-semibold animate-pulse">â° æ®‹ã‚Š ${diffHours}æ™‚é–“ (${expiryDateStr})</p>`;
                } else if (diffDays <= 3) {
                  expiryHtml = `<p class="text-sm mb-1 text-orange-500 font-semibold">â° ${expiryDateStr} (æ®‹ã‚Š${diffDays}æ—¥)</p>`;
                } else {
                  expiryHtml = `<p class="text-sm mb-1">â° ${expiryDateStr}</p>`;
                }
              } catch (e) { }
            }

            modalHtml += `
              <div class="border-b ${borderClass} pb-3 last:border-b-0">
                <p class="text-sm mb-1"><span class="font-semibold">${otherDeal.shop}</span></p>
                <p class="text-sm mb-1">${otherSale ? 'ã‚»ãƒ¼ãƒ«ä¾¡æ ¼' : 'ä¾¡æ ¼'}: <span class="text-red-500 font-bold">${otherDeal.priceNew}å††</span> ${otherSale ? `<span class="text-green-500">(${otherDeal.cut}%OFF)</span>` : ''}</p>
                ${otherSale ? `<p class="text-sm mb-1">é€šå¸¸ä¾¡æ ¼: <span class="line-through">${otherDeal.priceOld}å††</span></p>` : ``}
                ${expiryHtml}
                <div class="flex items-center justify-between gap-2 mt-1">
                  ${otherDeal.url ? `<a href="${otherDeal.url}" target="_blank" class="text-blue-500 hover:underline text-xs inline-block">ã‚¹ãƒˆã‚¢ãƒšãƒ¼ã‚¸ã¸ â†’</a>` : '<span class="text-xs opacity-60">ãƒªãƒ³ã‚¯ãªã—</span>'}
                   <button class="addToWishlistStoreBtn text-xs px-3 py-1 rounded-lg bg-gradient-to-r from-yellow-500 to-yellow-600 text-white font-semibold"
                          data-store-index="${idx}">
                    â­ ã“ã®ã‚¹ãƒˆã‚¢ã§è¿½åŠ 
                  </button>
                </div>
              </div>
            `;
          });

          modalHtml += `</div></div>`;
        }

        modalContent.innerHTML = modalHtml;

        // ä»–ã‚¹ãƒˆã‚¢ã®ã€Œã“ã®ã‚¹ãƒˆã‚¢ã§è¿½åŠ ã€
        modalContent.querySelectorAll(".addToWishlistStoreBtn").forEach(btn => {
          btn.addEventListener("click", async () => {
            if (!currentDeal) return;
            const idx = Number(btn.dataset.storeIndex);
            const target = Array.isArray(currentDeal.otherDeals) ? currentDeal.otherDeals[idx] : null;
            if (!target) return;

            const gameId = currentDeal.gameID || currentDeal.id;
            const payload = {
              gameId,
              gameTitle: currentDeal.title,
              gameImage: currentDeal.image,
              currentPrice: target.priceNew,
              shop: target.shop,
              url: target.url,
              priceOld: target.priceOld,
              cut: target.cut,
              expiry: target.expiry,
              historyLow: currentDeal.historyLow,
              historyLow1y: currentDeal.historyLow1y,
              historyLow3m: currentDeal.historyLow3m,
              storeLow: currentDeal.storeLow
            };

            if (payload.gameTitle === "Unknown" || !payload.gameTitle) {
              if (data.title) payload.gameTitle = data.title;
            }

            try {
              const res = await fetch("/api/wishlist", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
              });
              const result = await res.json();
              showToast(result.success ? "ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸï¼" : result.message, result.success);
              if (result.success) {
                setTimeout(() => location.reload(), 500);
              }
            } catch (err) {
              console.error(err);
              showToast("âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ", false);
            }
          });
        });

      } catch (err) {
        console.error(err);
        modalContent.innerHTML = `<p class="text-center ${darkMode ? 'text-gray-400' : 'text-gray-500'}">æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>`;
      }
    }


  </script>
</body>

</html>